---
title: "Homework 2"
subtitle: "Research in Health Economics, Spring 2025"
author: "Lisbeth Vargas"
format:
    pdf: 
        output-file: "vargas-hwk2-2"
        output-ext: "pdf"
        header-includes: 
            - \usepackage{float}
            - \floatplacement{table}{H}
knitr:
    opts_chunk:
        warning: false

---

```{r}
#| include: false
#| eval: true

load("/Users/lisbethvargas/Desktop/GitHub/Homework2/2-2/hwk2_workspace.Rdata")
```

```{r}
#| include: false

if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, ggplot2, dplyr, lubridate, readr, readxl, hrbrthemes, fixest,
               scales, gganimate, gapminder, gifski, png, tufte, plotly, OECD,
               ggrepel, survey, foreign, devtools, pdftools, kableExtra, modelsummary,
               kableExtra)
               
```

The following is my submission for Homework 2. Note that the setup and analysis for these responses are in a seperate `R` script. The GitHub repository for this work is available [here](https://github.com/lisvargasg/Homework2.git).

\newpage
# Summarize the Data

\noindent Question 1. How many hospitals filed more than one report in the same year? Show your answer as a line graph of the number of hospitals over time.<br>

```{r}
#| echo: false
report_counts <- duplicate.hcris %>%
  group_by(fyear) %>%
  summarise(num_hospitals = n_distinct(provider_number))

q1 <- ggplot(report_counts, aes(x = fyear, y = num_hospitals)) +
    geom_line() +
    labs(title = "Number of Hospitals Filing More than One Report per Year",
         x = "Fiscal Year",
         y = "Number of Hospitals") +
    theme_minimal()

q1
``` 

\newpage
\noindent Question 2. After removing/combining multiple reports, how many unique hospital IDs exist in the data?
9323 <br>



\noindent Question 3. What is the distribution of total charges in each year? Show your results with a “violin” plot.

```{r}
#| echo: false
final.hcris.data$tot_charges <- as.numeric(final.hcris.data$tot_charges)
final.hcris.data$fyear <- as.factor(final.hcris.data$year)

final.hcris.data <- final.hcris.data %>%
  filter(!is.na(tot_charges))

q3 = ggplot(final.hcris.data, aes(x = fyear, y = log(tot_charges))) +
  geom_violin(fill = "lightblue", color = "darkblue") +
  labs(
    title = "Log-transformed Distribution of Total Charges by Year",
    x = "Year",
    y = "Log of Total Charges"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

q3
```

\newpage
\noindent Question 4. What is the distribution of estimated prices in each year? Present your results with a violin plot.

```{r}
#| echo: false
final.hcris.data <- final.hcris.data %>%
  mutate(discount_factor = 1 - tot_discounts / tot_charges,  
    price_num = (ip_charges + icu_charges + ancillary_charges) * discount_factor - tot_mcare_payment, 
    price_denom = tot_discharges - mcare_discharges, 
    price = if_else(price_denom == 0 | is.na(price_num), NA_real_, price_num / price_denom))
  

quantiles <- quantile(final.hcris.data$price, c(0.01, 0.99), na.rm = TRUE)
final.hcris.data <- final.hcris.data %>%
  filter(price >= quantiles[1], price <= quantiles[2])

final.hcris.data$fyear <- as.factor(final.hcris.data$fyear)

q4 = ggplot(final.hcris.data, aes(x = fyear, y = price)) +
  geom_violin(fill = "lightblue", color = "darkblue") +  
  labs(
    title = "Distribution of Estimated Prices by Year",
    x = "Year",
    y = "Estimated Price"
  ) +
  theme_minimal() +  
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

q4
```

\newpage
\noindent Question 5. Calculate the average price among penalized versus non-penalized hospitals.

From my analysis, the average price among penalized hospitals is `r mean.pen <- round(mean(final.hcris$price[which(final.hcris$penalty==1)]))` and `r mean.nopen <- round(mean(final.hcris$price[which(final.hcris$penalty==0)]))` among non-penalized hospitals. 

\noindent Question 6. Split hospitals into quartiles based on bed size. Provide a table of the average price among treated/control groups for each quartile.

```{r}
#| echo: false
hcris.data <- readRDS("/Users/lisbethvargas/Desktop/GitHub/Homework2/2-1/data/output/HCRIS_Data.rds")

final.hcris.2012 <- hcris.data %>% ungroup() %>%
  filter(price_denom>100, !is.na(price_denom), 
         price_num>0, !is.na(price_num),
         price<100000, 
         beds>30, year==2012) %>%  #<<
  mutate( hvbp_payment = ifelse(is.na(hvbp_payment),0,hvbp_payment),
          hrrp_payment = ifelse(is.na(hrrp_payment),0,abs(hrrp_payment)), #<<
    penalty = (hvbp_payment-hrrp_payment<0)) #<<

bed_quartiles <- quantile(final.hcris.2012$beds, probs = c(0.25, 0.50, 0.75), na.rm = TRUE)

final.hcris.2012 <- final.hcris.2012 %>%
  mutate(
    Q1 = as.numeric((beds <= bed_quartiles[1]) & (beds > 0)),
    Q2 = as.numeric((beds > bed_quartiles[1]) & (beds <= bed_quartiles[2])),
    Q3 = as.numeric((beds > bed_quartiles[2]) & (beds <= bed_quartiles[3])),
    Q4 = as.numeric(beds > bed_quartiles[3]))

quartile_summary <- final.hcris.2012 %>%
  mutate(bed_quartile = case_when(
    Q1 == 1 ~ "Q1",
    Q2 == 1 ~ "Q2",
    Q3 == 1 ~ "Q3",
    Q4 == 1 ~ "Q4"
  )) %>%
  group_by(bed_quartile, penalty) %>%
  summarise(avg_price = mean(price, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(names_from = penalty, values_from = avg_price, names_prefix = "penalty_")

print(quartile_summary)
```